<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Vista de Solicitud</title>
    <link href="{{ url_for('static', filename='assets/css/request/request_view.css') }}" rel="stylesheet">
    <link rel="stylesheet" href="">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
</head>
<body>
    <meta name="csrf-token" content="{{ csrf_token }}">
    <div class="container-fluid mt-4" id="app">
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                        <h4 class="mb-0">Vista de Solicitud de Servicios</h4>
                        <div class="d-flex gap-2">
                            <!-- Botón Nuevo -->
                            <button class="btn btn-primary" @click="handleNewRequest">
                                Nueva solicitud
                            </button>

                            <!-- Botón Editar -->
                            <form :action="'/'" method="GET" class="d-inline">
                                <input type="hidden" name="edit" value="1">
                                <input type="hidden" name="data" :value="prepareDataForEdit()">
                                <button type="submit" class="btn btn-warning btn-sm">
                                    <i class="bi bi-pencil-square me-2"></i>
                                    Editar Solicitud
                                </button>
                            </form>

                            <!-- Botón PDF -->
                            <button type="button" 
                                    class="btn btn-primary btn-sm" 
                                    id="downloadPdfBtn" 
                                    @click="handleAction('download')" 
                                    :disabled="loading">
                                <span v-if="loading" class="spinner-border spinner-border-sm me-2" role="status"></span>
                                <i v-else class="bi bi-download me-2"></i>
                                Descargar PDF
                            </button>


                            <!-- Botón Email -->
                            <!-- <button type="button" 
                                    class="btn btn-success btn-sm" 
                                    @click="handleAction('email')" 
                                    :disabled="loading">
                                <span v-if="loading" class="spinner-border spinner-border-sm me-2" role="status"></span>
                                <i v-else class="bi bi-envelope me-2"></i>
                                Enviar por Email
                            </button> -->
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="row mb-4">
                            <!-- Información del Solicitante y Detalles -->
                            <div class="col-md-4">
                                <h5 class="border-bottom pb-2 mb-3">Información del Solicitante</h5>
                                <div class="mb-3">
                                    <p class="mb-2"><strong class="text-primary">Nombre:</strong> [[ data.applicant ]]</p>
                                    <p class="mb-2"><strong class="text-primary">Email:</strong> [[ data.email ]]</p>
                                    <p class="mb-2"><strong class="text-primary">Teléfono:</strong> [[ data.contact ]]</p>
                                    <p class="mb-2"><strong class="text-primary">Empresa:</strong> [[ data.department ]]</p>
                                </div>

                                
                            </div>
                            <div class="col-md-8">
                                <h5 class="border-bottom pb-2 mb-3">Detalles de la Actividad</h5>
                                <div class="mb-3">
                                    <p class="mb-2"><strong class="text-primary">Nombre:</strong> [[ data.activity_name ]]</p>
                                    <p class="mb-2"><strong class="text-primary">Ubicación:</strong> [[ data.activity_location ]]</p>
                                    <p class="mb-2">
                                        <strong class="text-primary">Tipo de Actividad:</strong> 
                                        <span class="badge" 
                                              :class="data.product_opt === 'recurrente' ? 'bg-warning' : 'bg-info'">
                                            [[ data.product_opt === 'recurrente' ? 'Actividad Recurrente' : 'Actividad Única' ]]
                                        </span>
                                    </p>
                                    
                                    <!-- Información para actividad única -->
                                    <template v-if="data.product_opt === 'unica'">
                                        <p class="mb-2">
                                            <strong class="text-primary">Fecha:</strong> 
                                            [[ data.start_date ? formatDate(data.start_date) : 'No especificada' ]]
                                        </p>
                                        <p class="mb-2">
                                            <strong class="text-primary">Hora Inicio:</strong> 
                                            [[ data.start ? formatTime(data.start) : 'No especificada' ]]
                                        </p>
                                        <p class="mb-2">
                                            <strong class="text-primary">Hora Fin:</strong> 
                                            [[ data.end ? formatTime(data.end) : 'No especificada' ]]
                                        </p>
                                    </template>
                                    
                                    <!-- Información para actividad recurrente -->
                                    <template v-if="data.product_opt === 'recurrente'">
                                        <div class="recurrence-info">
                                            <h4 class="text-primary mb-3">Patrón de Recurrencia</h4>
                                            
                                            <p class="mb-2">
                                                <strong class="text-primary">Tipo:</strong> 
                                                [[ data.recurrenceType ]]
                                            </p>

                                            <!-- Desglose según tipo de recurrencia -->
                                            <template v-if="data.recurrenceType === 'diaria'">
                                                <p class="mb-2">
                                                    <strong class="text-primary">Frecuencia:</strong> 
                                                    Todos los días
                                                </p>
                                            </template>

                                            <template v-if="data.recurrenceType === 'semanal'">
                                                <p class="mb-2">
                                                    <strong class="text-primary">Días seleccionados:</strong> 
                                                    [[ data.selectedWeekdays.join(', ') ]]
                                                </p>
                                            </template>

                                            <template v-if="data.recurrenceType === 'mensual'">
                                                <p class="mb-2">
                                                    <strong class="text-primary">Día del mes:</strong> 
                                                    [[ data.selectedMonthDay ]]
                                                </p>
                                            </template>

                                            <p class="mb-2">
                                                <strong class="text-primary">Periodo:</strong> 
                                                Del [[ formatDate(data.start_date) ]] al [[ formatDate(data.end_date) ]]
                                            </p>
                                            
                                            <p class="mb-2">
                                                <strong class="text-primary">Horario:</strong> 
                                                [[ data.start ]] a [[ data.end ]]
                                            </p>
                                            
                                            <!-- Sección de fechas programadas para todos los tipos de recurrencia -->
                                            <div class="mt-4">
                                                <h5 class="text-primary">Fechas Programadas:</h5>
                                                <div class="dates-grid">
                                                    <template v-if="data.recurrenceType === 'diario'">
                                                        <div v-for="date in calculateDailyDates(data.start_date, data.end_date)" 
                                                             :key="date" 
                                                             class="date-item">
                                                            [[ formatDate(date) ]]
                                                        </div>
                                                    </template>
                                                    
                                                    <template v-else-if="data.recurrenceType === 'semanal'">
                                                        <div v-for="date in calculateWeeklyDates(data.start_date, data.end_date, data.selectedWeekdays)" 
                                                             :key="date" 
                                                             class="date-item">
                                                            [[ formatDate(date) ]]
                                                        </div>
                                                    </template>
                                                    
                                                    <template v-else-if="data.recurrenceType === 'mensual'">
                                                        <div v-for="date in calculateMonthlyDates(data.start_date, data.end_date, data.selectedMonthDay)" 
                                                             :key="date" 
                                                             class="date-item">
                                                            [[ formatDate(date) ]]
                                                        </div>
                                                    </template>
                                                </div>
                                                <p class="mt-3">
                                                    <strong>Total de sesiones:</strong> 
                                                    <span v-if="data.recurrenceType === 'diario'">
                                                        [[ calculateDailyDates(data.start_date, data.end_date).length ]]
                                                    </span>
                                                    <span v-else-if="data.recurrenceType === 'semanal'">
                                                        [[ calculateWeeklyDates(data.start_date, data.end_date, data.selectedWeekdays).length ]]
                                                    </span>
                                                    <span v-else-if="data.recurrenceType === 'mensual'">
                                                        [[ calculateMonthlyDates(data.start_date, data.end_date, data.selectedMonthDay).length ]]
                                                    </span>
                                                </p>
                                            </div>
                                        </div>
                                    </template>

                                </div>

                                
                            </div>
                        </div>
                        
                        <!-- Sección de Patrón de Recurrencia -->
                        
                       
                        <!-- Agregar temporalmente para depuración -->
                        <div class="d-none">
                            Debug: [[ JSON.stringify(data) ]]
                        </div>

                        
                        <!-- Sección de Observaciones -->
                        <div class="row mt-4">
                            <div class="col-12">
                                <h5 class="border-bottom pb-2 mb-3">Observaciones Adicionales</h5>
                                <div class="card">
                                    <div class="card-body bg-light">
                                        <p class="mb-0">[[ data.observations || data.activity_details || 'Sin observaciones' ]]</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Sección de Servicios Seleccionados -->
                        <div class="row mt-4">
                            <div class="col-12">
                                <h5 class="border-bottom pb-2 mb-3">Servicios Seleccionados</h5>
                                <div class="card mb-4">
                                    <div class="card-body">
                                        <!-- Debug info -->
                                        <pre class="d-none">[[ JSON.stringify(data, null, 2) ]]</pre>

                                        <!-- Servicios Principales y sus subservicios -->
                                        <div class="mb-4" v-if="data.selectedMainServices && data.selectedMainServices.length > 0">
                                            <template v-for="mainService in data.selectedMainServices" :key="mainService">
                                                <div class="mb-3">
                                                    <h6 class="text-primary">
                                                        <i class="bi bi-check2-circle me-2"></i>
                                                        [[ mainService ]]
                                                    </h6>
                                                    <ul class="list-unstyled ms-4">
                                                        <template v-for="subService in subServiceOptions[mainService]" :key="subService">
                                                            <li v-if="data.selectedSubServices && data.selectedSubServices.includes(subService)">
                                                                <i class="bi bi-dash me-2"></i>
                                                                <span>[[ subService ]]</span>
                                                            </li>
                                                        </template>
                                                    </ul>
                                                </div>
                                            </template>
                                        </div>
                                        <div v-else>
                                            <p class="text-muted mb-0">No hay servicios seleccionados</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Primero, asegurémonos de que los datos estén disponibles en el template -->
    <div style="display: none;">
        <pre id="service-data">{{ data|tojson|safe }}</pre>
    </div>

    <!-- Agregar después del div.container-fluid -->
    <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 1050">
        <div class="toast" 
             :class="{ show: actionStatus.show }" 
             role="alert" 
             aria-live="assertive" 
             aria-atomic="true">
            <div class="toast-header" :class="actionStatus.type === 'success' ? 'bg-success text-white' : 'bg-danger text-white'">
                <i class="bi" :class="actionStatus.type === 'success' ? 'bi-check-circle' : 'bi-exclamation-circle'"></i>
                <strong class="ms-2 me-auto">Notificación</strong>
                <button type="button" class="btn-close" @click="hideStatus"></button>
            </div>
            <div class="toast-body">
                [[ actionStatus.message ]]
            </div>
        </div>
    </div>

    <style>
    .dates-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 10px;
        margin-top: 10px;
    }
    .date-item {
        padding: 8px;
        background-color: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 4px;
    }
    </style>

    <script>
    const { createApp } = Vue;
    
    createApp({
        delimiters: ["[[", "]]"],
        data() {
            let serviceData = {};
            try {
                const dataElement = document.getElementById('service-data');
                if (dataElement && dataElement.textContent) {
                    serviceData = JSON.parse(dataElement.textContent);
                    console.log('Datos cargados:', serviceData); // Debug
                }
            } catch (error) {
                console.error('Error al parsear los datos:', error);
            }

            return {
                data: serviceData,
                subServiceOptions: {
                    'Transmisión': ['Circuito Cerrado', 'Transmisión en vivo', 'Falso en vivo', 'Audio en vivo', 'Edición en vivo'],
                    'Cámara': ['Fotografía', 'Video'],
                    'Uso de Instalaciones': ['Estudio de TV', 'Sala de Edición'],
                    'Postproducción': ['Edición', 'Animación'],
                    'Distribución': ['Plataformas digitales', 'Redes sociales']
                },
                loading: false,
                actionStatus: {
                    message: '',
                    type: '', // 'success' o 'error'
                    show: false
                }
            };
        },
        computed: {
            isRecurrentActivity() {
                return this.data.product_opt === 'recurrente';
            },
            calculatedDates() {
                if (!this.data.start_date || !this.data.end_date || !this.data.recurrenceType) {
                    return [];
                }

                try {
                    let allDates = [];
                    const startDate = new Date(this.data.start_date + 'T00:00:00');
                    const endDate = new Date(this.data.end_date + 'T23:59:59');
                    let currentDate;

                    switch (this.data.recurrenceType) {
                        case 'diario':
                            currentDate = new Date(startDate);
                            while (currentDate <= endDate) {
                                const dayOfWeek = currentDate.getDay();
                                if (dayOfWeek !== 0 && dayOfWeek !== 6) {
                                    allDates.push(this.formatDateToString(currentDate));
                                }
                                currentDate.setDate(currentDate.getDate() + 1);
                            }
                            break;

                        case 'semanal':
                            if (!this.data.selectedWeekdays || !this.data.selectedWeekdays.length) {
                                console.log('No hay días seleccionados para recurrencia semanal');
                                return [];
                            }
                            
                            const selectedDays = this.data.selectedWeekdays.map(day => 
                                this.dayToNumber(this.normalizeDay(day))
                            );
                            console.log('Días seleccionados:', selectedDays);
                            
                            currentDate = new Date(startDate);
                            while (currentDate <= endDate) {
                                if (selectedDays.includes(currentDate.getDay())) {
                                    allDates.push(this.formatDateToString(currentDate));
                                }
                                currentDate.setDate(currentDate.getDate() + 1);
                            }
                            break;

                        case 'mensual':
                            if (!this.data.monthWeek || !this.data.selectedMonthDay) {
                                console.log('Faltan datos para recurrencia mensual');
                                return [];
                            }

                            const weekMap = {
                                'primera': 1,
                                'segunda': 2,
                                'tercera': 3,
                                'cuarta': 4,
                                'ultima': -1
                            };
                            
                            const targetDayNum = this.dayToNumber(this.normalizeDay(this.data.selectedMonthDay));
                            const targetWeek = weekMap[this.data.monthWeek];
                            
                            currentDate = new Date(startDate);
                            currentDate.setDate(1);

                            while (currentDate <= endDate) {
                                let monthDates = [];
                                let tempDate = new Date(currentDate);

                                while (tempDate.getMonth() === currentDate.getMonth()) {
                                    if (tempDate.getDay() === targetDayNum) {
                                        monthDates.push(new Date(tempDate));
                                    }
                                    tempDate.setDate(tempDate.getDate() + 1);
                                }

                                let targetDate;
                                if (targetWeek === -1) {
                                    targetDate = monthDates[monthDates.length - 1];
                                } else if (monthDates[targetWeek - 1]) {
                                    targetDate = monthDates[targetWeek - 1];
                                }

                                if (targetDate && targetDate >= startDate && targetDate <= endDate) {
                                    allDates.push(this.formatDateToString(targetDate));
                                }

                                currentDate.setMonth(currentDate.getMonth() + 1);
                            }
                            break;
                    }

                    console.log('Fechas calculadas:', allDates);
                    return allDates.sort();
                } catch (error) {
                    console.error('Error calculando fechas:', error);
                    return [];
                }
            },
            recurrencePattern() {
                if (!this.data.recurrenceType) return '';
                
                switch (this.data.recurrenceType) {
                    case 'diario':
                        return 'Todos los días hábiles';
                    case 'semanal':
                        return `Todos los ${this.data.selectedWeekdays.join(', ')}`;
                    case 'mensual':
                        const week = this.capitalizeFirstLetter(this.data.monthWeek);
                        const day = this.capitalizeFirstLetter(this.data.selectedMonthDay);
                        return `${week} ${day} de cada mes`;
                    default:
                        return '';
                }
            },
            totalSessions() {
                if (!this.data.isRecurrent || !this.calculatedDates) {
                    return 1; // Para actividad única
                }
                return this.calculatedDates.length;
            },
            filteredSubServices() {
                if (!this.data.selectedMainServices || !Array.isArray(this.data.selectedMainServices)) {
                    return [];
                }
                
                const allSubServices = [];
                this.data.selectedMainServices.forEach(mainService => {
                    if (this.subServiceOptions[mainService]) {
                        allSubServices.push(...this.subServiceOptions[mainService]);
                    }
                });
                
                return allSubServices;
            },
            selectedServices() {
                const services = [];
                
                if (Array.isArray(this.data.selectedMainServices)) {
                    services.push(...this.data.selectedMainServices);
                }
                
                if (Array.isArray(this.data.selectedSubServices)) {
                    services.push(...this.data.selectedSubServices);
                }
                
                return services;
            }
        },
        methods: {
            formatDateToString(date) {
                return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
            },
            getDayName(date) {
                return date.toLocaleDateString('es-ES', { 
                    weekday: 'long',
                    timeZone: 'UTC'
                });
            },
            normalizeDay(day) {
                return day.toLowerCase()
                         .normalize("NFD")
                         .replace(/[\u0300-\u036f]/g, "");
            },
            formatDate(dateStr) {
                if (!dateStr) return '';
                try {
                    const date = new Date(dateStr + 'T12:00:00');
                    return new Intl.DateTimeFormat('es', {
                        weekday: 'long',
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric'
                    }).format(date);
                } catch (error) {
                    console.error('Error formateando fecha:', error);
                    return dateStr;
                }
            },
            formatTime(timeStr) {
                if (!timeStr) return 'No especificada';
                
                try {
                    return new Intl.DateTimeFormat('es-ES', {
                        hour: '2-digit',
                        minute: '2-digit',
                        hour12: false
                    }).format(new Date(`2000-01-01T${timeStr}`));
                } catch (error) {
                    console.error('Error formateando hora:', error);
                    return timeStr;
                }
            },
            capitalizeFirstLetter(string) {
                if (!string) return '';
                return string.charAt(0).toUpperCase() + string.slice(1);
            },
            dayToNumber(day) {
                const dayMap = {
                    'domingo': 0,
                    'lunes': 1,
                    'martes': 2,
                    'miercoles': 3,
                    'miércoles': 3,
                    'jueves': 4,
                    'viernes': 5,
                    'sabado': 6,
                    'sábado': 6
                };
                return dayMap[day.toLowerCase()] || 0;
            },
            async handleAction(type) {
                this.loading = true;
                this.hideStatus();
                
                try {
                    const csrfToken = document.querySelector('meta[name="csrf-token"]').content;
                    
                    const response = await fetch(`/api/${type}-service`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': csrfToken
                        },
                        body: JSON.stringify(this.data)
                    });

                    // Si es una descarga de PDF, manejar la respuesta como blob
                    if (type === 'download') {
                        if (response.ok) {
                            const blob = await response.blob();
                            const url = window.URL.createObjectURL(blob);
                            const a = document.createElement('a');
                            a.href = url;
                            a.download = `solicitud-servicio-${this.data.activity_name || 'sin-nombre'}.pdf`;
                            document.body.appendChild(a);
                            a.click();
                            window.URL.revokeObjectURL(url);
                            a.remove();
                            
                            this.showStatus('PDF generado exitosamente', 'success');
                        } else {
                            throw new Error('Error al generar el PDF');
                        }
                    } else {
                        // Para otras acciones (como email)
                        const result = await response.json();
                        if (result.success) {
                            this.showStatus(
                                type === 'email' ? 'Email enviado exitosamente' : 'Operación exitosa',
                                'success'
                            );
                        } else {
                            throw new Error(result.message || 'Error en la operación');
                        }
                    }
                } catch (error) {
                    console.error(`Error en ${type}:`, error);
                    this.showStatus(
                        `Error al ${type === 'download' ? 'generar PDF' : 'enviar email'}: ${error.message}`,
                        'error'
                    );
                } finally {
                    this.loading = false;
                }
            },
            showStatus(message, type) {
                this.actionStatus = {
                    message,
                    type,
                    show: true
                };

                // Ocultar después de 5 segundos
                setTimeout(() => this.hideStatus(), 5000);
            },
            hideStatus() {
                this.actionStatus.show = false;
            },
            prepareDataForEdit() {
                try {
                    return JSON.stringify(this.data);
                } catch (error) {
                    console.error('Error al preparar datos para edición:', error);
                    return '{}';
                }
            },
            calculateDailyDates(startDate, endDate) {
                console.log('Calculando fechas diarias:', { startDate, endDate });
                if (!startDate || !endDate) return [];
                
                const dates = [];
                const start = new Date(startDate + 'T00:00:00');
                const end = new Date(endDate + 'T23:59:59');
                
                let currentDate = new Date(start);
                
                while (currentDate <= end) {
                    dates.push(currentDate.toISOString().split('T')[0]);
                    currentDate.setDate(currentDate.getDate() + 1);
                }
                
                console.log('Fechas diarias calculadas:', dates);
                return dates;
            },
            calculateWeeklyDates(startDate, endDate, selectedDays) {
                console.log('Calculando fechas semanales:', { startDate, endDate, selectedDays });
                if (!startDate || !endDate || !selectedDays || !selectedDays.length) return [];
                
                const dates = [];
                const start = new Date(startDate + 'T00:00:00');
                const end = new Date(endDate + 'T23:59:59');
                
                const daysMap = {
                    'Lunes': 1, 'Martes': 2, 'Miércoles': 3, 'Jueves': 4,
                    'Viernes': 5, 'Sábado': 6, 'Domingo': 0
                };
                
                const selectedDayNumbers = selectedDays.map(day => daysMap[day]);
                
                let currentDate = new Date(start);
                
                while (currentDate <= end) {
                    if (selectedDayNumbers.includes(currentDate.getDay())) {
                        dates.push(currentDate.toISOString().split('T')[0]);
                    }
                    currentDate.setDate(currentDate.getDate() + 1);
                }
                
                console.log('Fechas semanales calculadas:', dates);
                return dates;
            },
            calculateMonthlyDates(startDate, endDate, selectedDay) {
                console.log('Calculando fechas mensuales:', { startDate, endDate, selectedDay });
                if (!startDate || !endDate || !selectedDay) return [];
                
                const dates = [];
                const start = new Date(startDate + 'T00:00:00');
                const end = new Date(endDate + 'T23:59:59');
                
                const daysMap = {
                    'domingo': 0, 'lunes': 1, 'martes': 2, 'miércoles': 3,
                    'jueves': 4, 'viernes': 5, 'sábado': 6
                };
                
                // Determinar qué número de semana del mes es la fecha inicial
                const weekNumber = Math.ceil(start.getDate() / 7);
                console.log('Número de semana del mes:', weekNumber);
                
                let currentDate = new Date(start);
                currentDate.setDate(1); // Ir al primer día del mes
                
                while (currentDate <= end) {
                    let tempDate = new Date(currentDate);
                    const month = tempDate.getMonth();
                    let weekCount = 0;
                    
                    // Encontrar la ocurrencia específica del día en el mes
                    while (tempDate.getMonth() === month) {
                        if (tempDate.getDay() === daysMap[selectedDay.toLowerCase()]) {
                            weekCount++;
                            if (weekCount === weekNumber && 
                                tempDate >= start && 
                                tempDate <= end) {
                                dates.push(tempDate.toISOString().split('T')[0]);
                                break; // Solo una fecha por mes
                            }
                        }
                        tempDate.setDate(tempDate.getDate() + 1);
                    }
                    
                    // Avanzar al primer día del siguiente mes
                    currentDate.setMonth(currentDate.getMonth() + 1);
                    currentDate.setDate(1);
                }
                
                console.log('Fechas mensuales calculadas:', dates);
                return dates;
            },
            handleNewRequest() {
                // Limpiar datos almacenados
                localStorage.removeItem('serviceData');
                sessionStorage.removeItem('serviceData');
                
                // Limpiar el estado de la aplicación
                this.data = {
                    activity_details: null,
                    activity_location: '',
                    activity_name: '',
                    applicant: '',
                    contact: '',
                    department: '',
                    email: '',
                    end: '',
                    end_date: '',
                    id: '',
                    monthWeek: '',
                    observations: '',
                    product_opt: '',
                    recurrenceType: '',
                    selectedMainServices: [],
                    selectedMonthDay: '',
                    selectedSubServices: [],
                    selectedWeekdays: [],
                    start: '',
                    start_date: ''
                };
                
                // Redirigir a la página de nueva solicitud
                window.location.href = '/';
            }
        },
        mounted() {
            console.log('Componente montado. Datos:', this.data); // Debug
            if (this.data.product_opt === 'recurrente') {
                console.log('Tipo de recurrencia:', this.data.recurrenceType);
                console.log('Fechas:', {
                    inicio: this.data.start_date,
                    fin: this.data.end_date
                });
            }
        }
    }).mount("#app");

    document.addEventListener("DOMContentLoaded", function () {
        const modal = document.getElementById("customModal");

        if (modal) {
            modal.classList.add("show");
            modal.style.display = "flex";
        } else {
            console.error("❌ Error: No se encontró el modal con ID 'customModal'.");
        }
    });

    function closeCustomModal() {
        const modal = document.getElementById("customModal");
        if (modal) {
            modal.classList.remove("show");
            setTimeout(() => { modal.style.display = "none"; }, 300);
        }

        highlightDownloadButton();
    }



    function highlightDownloadButton() {
        const button = document.getElementById("downloadPdfBtn");
        const modalButton = document.querySelector(".custom-modal-btn");

        if (!button || !modalButton) {
            console.error("❌ Error: No se encontró uno de los botones.");
            return;
        }

        const startRect = modalButton.getBoundingClientRect();
        const endRect = button.getBoundingClientRect();

        const focusOverlay = document.createElement("div");
        focusOverlay.classList.add("focus-overlay");

        const tracker = document.createElement("div");
        tracker.classList.add("tracker");
        tracker.style.top = `${startRect.top + window.scrollY + startRect.height / 2 - 10}px`;
        tracker.style.left = `${startRect.left + window.scrollX + startRect.width / 2 - 10}px`;

        document.body.appendChild(focusOverlay);
        document.body.appendChild(tracker);

        const moveX = endRect.left - startRect.left + (endRect.width / 2 - 10);
        const moveY = endRect.top - startRect.top + (endRect.height / 2 - 10);

        setTimeout(() => {
            tracker.style.setProperty("--move-x", `${moveX}px`);
            tracker.style.setProperty("--move-y", `${moveY}px`);
            tracker.style.animation = "flip-move 1s ease-in-out forwards";
        }, 50);

        setTimeout(() => {
            button.classList.add("pulse-effect");
        }, 1000);

        setTimeout(() => {
            focusOverlay.remove();
            tracker.remove();
            button.classList.remove("pulse-effect");
        }, 2000);
    }
    </script>
    <!-- Modal -->
    <div id="customModal" class="custom-modal">
        <div class="custom-modal-content warning">
            <button class="custom-modal-close" onclick="closeCustomModal()">&times;</button>
            <div class="custom-modal-warning-icon">
                <i class="bi bi-exclamation-triangle-fill"></i> <!-- Icono de Bootstrap -->
            </div>
            <h2>¡Atención! No olvides descargar el PDF</h2>
            <p>
                Has generado una <strong>vista previa</strong> de la solicitud, pero <strong>NO se ha enviado aún.</strong>  
                Para guardar una copia, debes descargar el PDF antes de cerrar esta página.  
                <br><br>
                <strong>Haz clic en "Descargar PDF" después de cerrar este mensaje.</strong>
            </p>
            <button class="custom-modal-btn" onclick="closeCustomModal()">Entendido</button>
        </div>
    </div>


    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>